---
title: "Portfolio"
author: "Arthur Harnisch"
date: "November 15, 2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
###Outline of R Code Function for Muscle Tension Analysis and Graphs

Experiments are conducted as a repeated measure design. Treatment and control experiments were conducted as separate trials. Trials typically occur for 100 minutes, but may occur for more or less time depending on protocol and quality of the signal. A python code, "python tension.py" was used to gather data at the relevant time points for peak tension (highest point of static stretch), minimum tension (lowest point of static stretch), baseline tension (10 sec beofre static stretch), and SR ( average between 3.25-3.75 sec. of 4 sec static stretch) for every ramp (static stretch) throughout the experiment. The python out-put is .csv and the file name was saved as analyzed year, month, date, muscle number, and trial letter. Under the file directory in a folder entitled tension, four folders exist experiment, control, img, and experiment output.  Python.csv files were placed in experiment and control based on the type of trial, the image for the graph (point 6 below) placed in folder img entitled img (png file), and excel output will receive the excel output from the r codethat organizes baseline, peak, SR, and minimum tension values group for each trial on one sheet. The features of this r code are listed below.  

1. Imports multiple.csv files for both experiment and control and creates a data frame of all .csv files for each (Exp, and Control). The name of the file is used to organize the information within the data frame. 

2. Calculates the percent variation from baseline for Baseline, peak, SR, and minimum tension in seperate columns for experiment and control. 

3. Produces a combination line plot (10 sec. before static stretch (baseline tension), peak tension, average tension 3.25-3.27 of 4 sec. static stretch, and minimum tension) that shows the percent variation from baseline (first 20 minutes of experiment) over time of the experiment and contains a legend for the date of each trial. Each graph is produced independently as well as grouped multi-plots of treatment and control. 

4. Produces a line plot of averages compared to time of experiment for multiple trials for average tension 3.25-3.75 of 4 sec. static stretch with error bars. This code will produce a graph of averages for treatment and control, a single plot of averages with two lines with error bars for treatment and control, and both individual graphs of average treatment and control faceted together.  

5. Produces graphs of dot plots with error bars of the average SR (3.25-3.75 of static stretch) per 20 minutes of the experiment for every trial. Graphs are produced independently for treatment and control, a multiplot that shows treatment and control, and a single graph that shows treatment and control.    

6. Produces a line plot of peak tension as a percent variation from baseline tension over time of experiment. This graph also includes a picture of the afferent firing caused by the first static stretch. The caption of this graph lists the standard deviation values for each 20-minute period of the experiment. 

7. outputs a table for 10 sec. before static stretch (baseline tension), peak tension, average tension 3.25-3.27 of 4 sec. static stretch, and minimum tension in an excel (xlsx) format. 
note: 

Required packages: ggplot2, dplyr, splitstackshape, reshape, grid, png.


###Installing Packages
this chunk lists packages that are required for the code to function. Some packages are listed as didn't use since they may be helpful if this code needs to be further developed. All of the items in this chunk are commented out so that the r markdown can knit.  
```{r packageInstall}
# Packages necessary for this r code
#sections are commented out so document can knit

#ggplot2

#install.packages("ggplot2") #this command is commented out untill it becomes necessary to use. 

#dataloader
#install.packages("DataLoader")# did not use but thought helpful

#dplyr
#install.packages("dplyr")

#splitstackshape
#install.packages("splitstackshape")


#reshape
#install.packages("reshape")

#reshape2
#install.packages("reshape2")

#tidyr
#install.packages("tidyr")# did not use but thought helpful

#png
#install.packages("png")

#magick
#install.packages("magick")#didn't uses

#here
#install.packages("here")#didn't use

#magrittr
#install.packages("magrittr")#didn't use

#read JPGE
#install.packages("jpeg")#didn't use 

#grid
#install.packages("grid")

#xlsx
#install.packages("xlsx")
#gridExtra
#install.packages("gridExtra")# didn't use



```
###Importing data

A folder named Tension_R was created so that multiple .csv files could be placed into it and analyzed. In this folder there are two folders, Experiment and Control. .csv files from a drug trial are placed under experiment and control files are placed under control.   

```{r dataImport}


#load multiple.csv files

#library(DataLoader)

#temp = importCsv(path = "../Tension_R/Control")
#list.filenames = list.files("../Tension_R/Control", pattern = "*.csv$")

#will import multiple files from a path into one data frame only if the same length
#library(DataLoader)
#tem3 = importAllSdf(path = "../Tension_R/Control")

#multiple data import for experiment by use of for loop to find .csv files and rbind. 

myfiles=dir("../Tension_R/Experiment", pattern = "*.csv$", all.files = TRUE, full.names = TRUE)


for(i in 1: length(myfiles) ){
  
  #open each file
  # read.csv(myfiles[i])
  temp = read.csv(myfiles[i])
  fname = basename(myfiles[i])
  
  loc = regexpr(pattern = "[[:digit:]]+[-_][[:digit:]][[:alpha:]]", text = fname)
  trial = substr(fname, start = loc[[1]], stop = loc[[1]] + (attr(loc,'match.length')-1))
  trial = sub(pattern = '_','-', x= trial)
  
  temp2 = temp[-(which(temp$Ramp.. == '')),]
  
  macroRows = which(temp2$Ramp.. == 'for macro #:')
  
  temp2$Macro = NA
  
  for (j in 1:length(macroRows)){
    macroNum = temp2$BL.tension[macroRows[j]]
    if (j < length(macroRows)){
      temp2$Macro[(macroRows[j]+1) : (macroRows[j+1]-1) ] = macroNum
    } else if (j == length(macroRows)){
      temp2$Macro[(macroRows[j]+1) : nrow(temp2) ] = macroNum
    }
  }
  
  temp2 = temp2[-(macroRows), ]
  temp2 = droplevels(temp2)
  temp2$Ramp.. = as.numeric(as.character(temp2$Ramp..))
  temp2$Ramp..[temp2$Ramp.. == 0] = 6
  
  temp2$Trial = trial


  
  if ( i == 1){
    Exp = temp2
  } else {
    Exp = rbind( Exp, temp2)
  }
}



#create a data frame for control

myfiles=dir("../Tension_R/Control", pattern = "*.csv$", all.files = TRUE, full.names = TRUE)

# For control 
for(i in 1: length(myfiles) ){
  
  #open each file
  # read.csv(myfiles[i])
  temp = read.csv(myfiles[i])
  fname = basename(myfiles[i])
  
  loc = regexpr(pattern = "[[:digit:]]+[-_][[:digit:]][[:alpha:]]", text = fname)
  trial = substr(fname, start = loc[[1]], stop = loc[[1]] + (attr(loc,'match.length')-1))
  trial = sub(pattern = '_','-', x= trial)
  
  temp2 = temp[-(which(temp$Ramp.. == '')),]
  
  macroRows = which(temp2$Ramp.. == 'for macro #:')
  
  temp2$Macro = NA
  
  for (j in 1:length(macroRows)){
    macroNum = temp2$BL.tension[macroRows[j]]
    if (j < length(macroRows)){
      temp2$Macro[(macroRows[j]+1) : (macroRows[j+1]-1) ] = macroNum
    } else if (j == length(macroRows)){
      temp2$Macro[(macroRows[j]+1) : nrow(temp2) ] = macroNum
    }
  }
  
  temp2 = temp2[-(macroRows), ]
  temp2 = droplevels(temp2)
  temp2$Ramp.. = as.numeric(as.character(temp2$Ramp..))
  temp2$Ramp..[temp2$Ramp.. == 0] = 6
  
  temp2$Trial = trial


  
  if ( i == 1){
    Control = temp2
  } else {
    Control = rbind( Control, temp2)
  }
}


              

```

###Data manipulation 

This code finds the percent variation from baseline for 10 sec. before static stretch (baseline tension), peak tension, average tension 3.25-3.27 of 4 sec. static stretch, and minimum tension


###Percent Variation from Baseline of Experiment 


```{r dataManipulation_EXP}

#calculates the percept variation from baseline for each of the trials and makes a seperate column to display the percent from variation 10 sec. before static stretch (baseline tension), peak tension, average tension 3.25-3.27 of 4 sec. static stretch, and minimum tension. 



#data manipulations are for Experiment group


# finding the percent variation from baseline (first 6 time points of file) of BL.tension 

 

library(dplyr)
Exp1 = tbl_df(Exp)

# res = filter(Exp1, Macro == 1, Ramp.. <7)   #dplyr filter 

 res1 = Exp1[Exp1$Macro == 1 & Exp1$Ramp.. < 7,] #base r filter 

res2 = res1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.BL.Tension = mean(BL.tension, na.rm = TRUE))


  Exp$avg_BSL.BLtension = res2$avg_BSL.BL.Tension[match(Exp$Trial, res2$Trial)]


Exp$pvb.BL.tension = Exp$BL.tension / Exp$avg_BSL.BLtension


#finding the percent variation from baseline in Peak tension

res3 = res1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.peak.tension = mean(peak.tension, na.rm = TRUE))


 Exp$avg_BSL.peak.tension = res3$avg_BSL.peak.tension[match(Exp$Trial, res3$Trial)]
 
 Exp$pvb.peak.tension = Exp$peak.tension / Exp$avg_BSL.peak.tension
 
 #finding the percent variation form baseline in 3.25 - 3.75 
 
 
 res4 = res1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.SR = mean(average.of.all.interval.points, na.rm = TRUE))


 Exp$avg_BSL.SR = res4$avg_BSL.SR[match(Exp$Trial, res4$Trial)]
 
 Exp$pvb.SR = Exp$average.of.all.interval.points / Exp$avg_BSL.SR

 
 # finding the percent variation from baseline in Minimum values 

 
  
 res5 = res1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.min = mean(Min.value, na.rm = TRUE))


 Exp$avg_BSL.min = res5$avg_BSL.min[match(Exp$Trial, res5$Trial)]
 
 Exp$pvb.min = Exp$Min.value / Exp$avg_BSL.min
 
 
 #creating numeric x-axis for plotting that will label the ramp number in the file for each file. 
 
 library(splitstackshape)
 
 Exp5 = getanID(data = Exp, id.vars = "Trial")
 
Exp$ramp.num = Exp5$.id

 



#reshape data for BL tension
#library(reshape)
#Exp7 = cast(Exp, ramp.num~Trial, value = "pvb.BL.tension" )




 
```


###Percent variation from baseline of Control

This is a code to find the percent variation from baseline of the files that were placed in the folder labeled Control 


```{r dataManipulation_Control}


 #data manipulation for Control
 library(dplyr)

 control1 = tbl_df(Control)

# res = filter(Exp1, Macro == 1, Ramp.. <7)   #dplyr filter 

 con1 = control1[control1$Macro == 1 & control1$Ramp.. < 7,] #base r filter 

con2 = con1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.BL.Tension = mean(BL.tension, na.rm = TRUE))


  Control$avg_BSL.BLtension = con2$avg_BSL.BL.Tension[match(Control$Trial, con2$Trial)]


Control$pvb.BL.tension = Control$BL.tension / Control$avg_BSL.BLtension


#finding the percent variation from baseline in Peak tension

con3 = con1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.peak.tension = mean(peak.tension, na.rm = TRUE))


 Control$avg_BSL.peak.tension = con3$avg_BSL.peak.tension[match(Control$Trial, con3$Trial)]
 
 Control$pvb.peak.tension = Control$peak.tension / Control$avg_BSL.peak.tension
 
 #finding the percent variation form baseline in 3.25 - 3.75 
 
 
 con4 = con1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.SR = mean(average.of.all.interval.points, na.rm = TRUE))


 Control$avg_BSL.SR = con4$avg_BSL.SR[match(Control$Trial, con2$Trial)]
 
 Control$pvb.SR = Control$average.of.all.interval.points / Control$avg_BSL.SR

 
 # finding the percent variation from baseline in Minimum values 

 
  
 con5 = con1 %>%
  group_by(Trial)%>%
  summarise(avg_BSL.min = mean(Min.value, na.rm = TRUE))


 Control$avg_BSL.min = con5$avg_BSL.min[match(Control$Trial, con2$Trial)]
 
 Control$pvb.min = Control$Min.value / Control$avg_BSL.min

 
 
 library(splitstackshape)
 
 Control5 = getanID(data = Control, id.vars = "Trial")
 
Control$ramp.num = Control5$.id




#subsetting data frame to add categorical variable




Macro_cat_var = levels = c('Macro 1 Ramp #1 46 sec', '#2 250-254 sec','#3 454-458 sec','#4 657-661 sec',"#5 861-865sec","#6 1065 - 1069 sec","Macro 2 Ramp #1 1115 sec", '#2 1319-1323 sec','#3 1523-1527 sec',' #4 1727-1731 sec','#5 1931- 1935 sec','#6 2135-2139 sec','Macro 3 Ramp #1 2185 sec','#2 2389-2393 sec','#3 2593-2597 sec','#4 2797 -2801 sec','#5 3001-3005 sec','#6 3205-3209 sec', 'Macro 4 Ramp #1 3255 sec','#2 3459-3463 sec','#3 3662-3667 sec','#4 3867-3871 sec','#5 4071-4075 sec.','#6 4275-4279 sec','Macro 5 Ramp #1 4325 sec','#2 4529-4533 sec','#3 4733-4737','#4 4937-4941 sec','#5 5141-5145 sec','#6 5345-5349 sec','Macro 6 Ramp #1 5395 sec','#2 5599-5603 sec','#3 5803-5807 sec','#4 6007-6011 sec.','#5 6211-6215 sec.','#6 6415-6419 sec','Macro 7 Ramp #1 6465 sec','#2 6669-6673 sec.','#3 6873-6877 sec.','#4 7077-7081 sec.','#5 7281-7285 sec.','#6 7485-7489 sec')



Macro_cat_var = levels = c('1_1 46-50 sec', '1_2 250-254 sec','1_3 454-458 sec','1_4 657-661 sec',"1_5 861-865sec","1_6 1065 - 1069 sec","2_1 1115 sec", '2_2 1319-1323 sec','2_3 1523-1527 sec','2_4 1727-1731 sec','2_5 1931- 1935 sec','2_6 2135-2139 sec','3_1 2185-2189 sec','3_2 2389-2393 sec','3_3 2593-2597 sec','3_4 2797 -2801 sec','3_5 3001-3005 sec','3_6 3205-3209 sec', '4_1 3255-3259 sec','4_2 3459-3463 sec','4_3 3662-3667 sec','4_4 3867-3871 sec','4_5 4071-4075 sec.','4_6 4275-4279 sec','5_1 4325 sec','5_2 4529-4533 sec','5_3 4733-4737','5_4 4937-4941 sec','5_5 5141-5145 sec','5_6 5345-5349 sec','6_1 5395-5399 sec','6_2 5599-5603 sec','6_3 5803-5807 sec','6_4 6007-6011 sec.','6_5 6211-6215 sec.','6_6 6415-6419 sec','7_1 6465-6469 sec','7_2 6669-6673 sec.','7_3 6873-6877 sec.','7_4 7077-7081 sec.','7_5 7281-7285 sec.','7_6 7485-7489 sec')

Macro_cat_var1 = as.data.frame(Macro_cat_var)
Macro_cat_var1$id = 1:length(Macro_cat_var)

#Exp$Macro_cat_var1 = Macro_cat_var1$Macro_cat_var[match(Exp$ramp.num, Macro_cat_var1$id)]

# res = filter(Exp1, Macro == 1, Ramp.. <7)   #dplyr filter 


``` 
###Combination line plot

 Produces a combination line plot (10 sec. before static stretch (baseline tension), peak tension, average tension 3.25-3.27 of 4 sec. static stretch, and minimum tension) that shows the percent variation from baseline (first 20 minutes of experiment) over time of the experiemnt and contains a legend for the date of each trial. Individual graphs are produced for baseline, peak, SR and minimum tension for both experiment and control.  

```{r CombinationLineplot}


library(ggplot2)


#graphs for Experiment group

#plot of baseline tension over time and will display each graph individually for Experiment group

#Baseline tension

ggplot(Exp, aes(x= ramp.num, y= pvb.BL.tension, color = Trial)) +
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+ 
  ggtitle("Baseline Tension")+
  theme(plot.title = element_text(hjust=0.5)) +
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline",  breaks = round(seq(min(Exp$pvb.BL.tension), max(Exp$pvb.BL.tension), by = 0.1),1)) 
  
  

#plot of peak tension

ggplot(Exp, aes(x = ramp.num, y=pvb.peak.tension, color = Trial)) +
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("Peak Tension")+
theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Exp$pvb.peak.tension), max(Exp$pvb.peak.tension), by = 1.2),1))



#plot of peak plateu 3.25-3.75

ggplot(Exp, aes(x=ramp.num, y=pvb.SR, color= Trial))+
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("SR") +
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)",breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Exp$pvb.SR), max(Exp$pvb.SR), by = 0.8),1))


#plot of min tension

ggplot(Exp, aes(x=ramp.num, y=pvb.min, color = Trial))+
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1)) +
  ggtitle("Minimum")+
  theme(plot.title = element_text(hjust=0.5))+
   scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Exp$pvb.min), max(Exp$pvb.min), by = 2),1))


#plot of graphs for control group


#BL.Tension

ggplot(Control, aes(x= ramp.num, y= pvb.BL.tension, color = Trial)) +
    geom_point()+
     geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("Control Baseline Tension")+
  theme(plot.title = element_text(hjust=0.5))+scale_x_continuous("Time(Min.)")+
   scale_x_continuous("Time(Min.)", breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline",  breaks = round(seq(min(Control$pvb.BL.tension), max(Control$pvb.BL.tension), by = 0.1),1)) 



#plot of peak tension

ggplot(Control, aes(x = ramp.num, y=pvb.peak.tension, color = Trial))+
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
ggtitle("Control Peak Tension")+
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Control$pvb.peak.tension), max(Control$pvb.peak.tension), by = 1.2),1)) 


#plot of peak plateu 3.25-3.75

ggplot(Control, aes(x=ramp.num, y=pvb.SR, color= Trial))+  
  geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1)) +
  ggtitle("Control SR")+
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)",breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Control$pvb.SR), max(Control$pvb.SR), by = 0.8),1))

#plot of min tension

library(ggplot2)

ggplot(Control, aes(x=ramp.num, y=pvb.min, color = Trial))+
  geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("Control Minimum")+
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Control$pvb.min), max(Control$pvb.min), by = 2),1))
  


```

### Multiple plot for multiple line plot

Produces a multiplot for each combination line plot. Baseline tension, peak tension, average tension 3.25-3.27 of 4 sec. static stretch, and minimum tension) that shows the percent variation from baseline (first 20 minutes of experiment) over time of the experiment and contains a legend for the date of each trial. 
```{r combinationLineplot}

#combining the individual plots so they can be compared


# new funciton called multiple plot funciton

# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}



#create labels for each plot Experiment 

library(ggplot2)


#Baseline tension

a1 = ggplot(Exp, aes(x= ramp.num, y= pvb.BL.tension, color = Trial)) +
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+ 
  ggtitle("Baseline Tension")+
  theme(plot.title = element_text(hjust=0.5)) +
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline",  breaks = round(seq(min(Exp$pvb.BL.tension), max(Exp$pvb.BL.tension), by = 0.1),1))+
  theme(legend.position = "none")


#plot of peak tension

b1 = ggplot(Exp, aes(x = ramp.num, y=pvb.peak.tension, color = Trial)) +
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("Peak Tension")+
theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Exp$pvb.peak.tension), max(Exp$pvb.peak.tension), by = 1.2),1))+theme(legend.position = "none")



#plot of peak plateu 3.25-3.75

c1 = ggplot(Exp, aes(x=ramp.num, y=pvb.SR, color= Trial))+
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("SR") +
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)",breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Exp$pvb.SR), max(Exp$pvb.SR), by = 0.8),1))+theme(legend.position = "none")


#plot of min tension

d1 = ggplot(Exp, aes(x=ramp.num, y=pvb.min, color = Trial))+
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1)) +
  ggtitle("Minimum")+
  theme(plot.title = element_text(hjust=0.5))+
   scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Exp$pvb.min), max(Exp$pvb.min), by = 2),1))


  

#use the multiplot function to combine all plots in multiplot function

multiplot(a1,b1,c1,d1, cols=2)

#creating labels for control plot 

a_2 = ggplot(Control, aes(x= ramp.num, y= pvb.BL.tension, color = Trial)) +
    geom_point()+
     geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("Control Baseline Tension")+
  theme(plot.title = element_text(hjust=0.5))+scale_x_continuous("Time(Min.)")+
   scale_x_continuous("Time(Min.)", breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline",  breaks = round(seq(min(Control$pvb.BL.tension), max(Control$pvb.BL.tension), by = 0.1),1)) +theme(legend.position = "none")


#plot of peak tension

b_2 = ggplot(Control, aes(x = ramp.num, y=pvb.peak.tension, color = Trial))+
    geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
ggtitle("Control Peak Tension")+
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Control$pvb.peak.tension), max(Control$pvb.peak.tension), by = 1.2),1)) +theme(legend.position = "none")



#plot of peak plateu 3.25-3.75

c_2 = ggplot(Control, aes(x=ramp.num, y=pvb.SR, color= Trial))+  
  geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1)) +
  ggtitle("Control SR")+
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)",breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Control$pvb.SR), max(Control$pvb.SR), by = 0.8),1))+theme(legend.position = "none")

#plot of min tension

d_2 = ggplot(Control, aes(x=ramp.num, y=pvb.min, color = Trial))+
  geom_point()+
  geom_line()+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+
  ggtitle("Control Minimum")+
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous("Time(Min.)", breaks = round(seq(min(Control$ramp.num), max(Control$ramp.num), by=2),1))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline", breaks = round(seq(min(Control$pvb.min), max(Control$pvb.min), by = 2),1))



  multiplot(a_2,b_2,c_2,d_2, cols = 2)



#creates two columns to compare treatment and control

#creates facet of multiple graphs comparing treatment to control

#multiplot(a1,b1,c1,d1,a_2,b_2,c_2,d_2, cols =2)



```
###Plot of averages

 Produces a line plot of averages compared to time of experiment for multiple trials for average tension 3.25-3.75 of 4 sec. static stretch with error bars. This code will produce a graph of averages for treatment and control, a single plot of averages with two lines with error bars for treatment and control, and both individual graphs of average treatment and control faceted together.   

```{r plotAverages}

#groups the ramp number and takes the average of all SR values for both experiment and control

#experimnet group calculations

#experiment subset and calculation of mean, standard deviation, and standard error. 

library(dplyr)


Exp8 = Exp %>%
  group_by(Macro)%>%
  summarise(avg.all.macro = mean(average.of.all.interval.points, na.rm = TRUE))


 Exp8_sd = Exp%>%
  group_by(Macro)%>%
  summarise(sd = sd(average.of.all.interval.points, na.rm = TRUE))

 Exp8$sd = Exp8_sd$sd
 
Exp10 = as.data.frame(table(Exp$Macro))
  Exp9 =  sqrt(Exp10$Freq)
 Exp8$SE = Exp8$sd / Exp9

 Exp8$ymin = Exp8$avg.all.macro - Exp8$SE
 Exp8$ymax = Exp8$avg.all.macro + Exp8$SE
 
 Exp8$type = "Drug"
 
#control subset and calculation of mean, standard deviation, and standard error.  
 
 Con8 = Control %>%
  group_by(Macro)%>%
  summarise(avg.all.macro = mean(average.of.all.interval.points, na.rm = TRUE))

 Con8_sd = Control%>%
  group_by(Macro)%>%
  summarise(sd = sd(average.of.all.interval.points, na.rm = TRUE))

 Con8$sd = Con8_sd$sd
 
 
Con10 = as.data.frame(table(Exp$Macro))
   Con9 =  sqrt(Con10$Freq)
   Con8$SE = Con8$sd / Con9

   Con8$ymin = Con8$avg.all.macro - Con8$SE
   Con8$ymax = Con8$avg.all.macro + Con8$SE
   
    Con8$type = "Control"
 
 
    
    #binds data frame to compare treatment and control in plot
     Exp_Con = rbind(Exp8, Con8)
 
     
     
     

library(ggplot2)

#plot of treatment group
   ggplot(Exp8,aes(x=Macro, y=avg.all.macro, group = type, color = type)) + 
   geom_errorbar(aes(ymin= ymin, ymax=ymax), width= .1) +
    geom_line() +
     scale_colour_manual(values = "steelblue")+
    geom_point()+
       ggtitle("Average SR versus Time for Treatment Group\n")+
  theme(plot.title = element_text(hjust=0.5))+
  labs(x="Time\n", y = "Average SR\n")+
        scale_x_continuous(breaks = round(seq(min(Con8$Macro), max(Con8$Macro), by=1),1))+
  theme(axis.text.x = element_text(angle = 0, hjust = 1))
     
     
   
     
#plot of control group 
     
   ggplot(Con8, aes(x=Macro, y=avg.all.macro, group =type, color = type)) + 
   geom_errorbar(aes(ymin= ymin, ymax=ymax), width=.1) +
    geom_line() +
     scale_colour_manual(values = "darkblue")+
    geom_point()+
       ggtitle("Average SR versus Time for Control Group\n")+
  theme(plot.title = element_text(hjust=0.5))+
  labs(x="Time\n", y = "Average SR\n")+
        scale_x_continuous(breaks = round(seq(min(Con8$Macro), max(Con8$Macro), by=1),1))+
  theme(axis.text.x = element_text(angle = 0, hjust = 1))
     
# side by side plot of control and treatment 
   
    z1= ggplot(Exp8,aes(x=Macro, y=avg.all.macro, colour= type)) + 
   geom_errorbar(aes(ymin= ymin, ymax=ymax), width=.1) +
       scale_colour_manual(values = "steelblue")+
    geom_line() +
    geom_point()+
     ggtitle("Average SR versus Time for Treatment and Control\n")+
      theme(plot.title = element_text(hjust=0.5))+
         scale_x_continuous(breaks = round(seq(min(Con8$Macro), max(Con8$Macro), by=1),1))+
  theme(axis.text.x = element_text(angle = 0, hjust = 1))+
    theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
    
 z2=  ggplot(Con8, aes(x=Macro, y=avg.all.macro, colour= type)) + 
   geom_errorbar(aes(ymin= ymin, ymax=ymax), width=.1) +
   scale_colour_manual(values = "green")+
    geom_line() +
    geom_point()+
   scale_x_continuous("Time(Min.)", breaks = round(seq(min(Con8$Macro), max(Con8$Macro), by=1),1))+
  theme(axis.text.x = element_text(angle = 0, hjust = 1))
   
   
 multiplot(z1,z2, cols = 1)  
     
# single graph comparing treatment and control
 
ggplot(Exp_Con, aes(x=Macro, y=avg.all.macro, colour= type)) + 
  geom_errorbar(aes(ymin= ymin, ymax=ymax), width=.1) +
    geom_line() +
    geom_point()+
    ggtitle("Average SR versus Time for Treatment and Control\n")+
 theme(plot.title = element_text(hjust=0.5))+
 labs(x="Time\n", y = "Average SR\n")+
     scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp_Con$Macro), max(Exp_Con$Macro), by=1),1))+
  theme(axis.text.x = element_text(angle = 0, hjust = 1))


#faceting data to compare treatment and control
Exp_Con = rbind(Exp8,Con8)

ggplot(Exp_Con, aes(x=Macro, y=avg.all.macro, group = type, color = type))+
  geom_line()+
  scale_colour_manual(values = c("steelblue", "darkblue"))+
  geom_point()+
  geom_errorbar(aes(ymin=ymin, ymax=ymax), width = .1)+
  facet_grid(type~.)+
  ggtitle("Average SR versus Time for Treatment and Control\n")+
  theme(plot.title = element_text(hjust=0.5))+
#theme(legend.position = "none")#+   #uncomment if you want to remove legend
#expand_limits(y=0)#+   #if you want to change the limits of the y-axis, uncomment and set the scale for y axis
labs(x="Time\n", y = "Average SR\n")+
     scale_x_continuous(breaks = round(seq(min(Exp_Con$Macro), max(Exp_Con$Macro), by=1),1))+
  theme(axis.text.x = element_text(angle = 0, hjust = 1))
 
 



  
```


###Dot plots with mean and error bars

Produces graphs of dot plots with error bars of the average SR (3.25-3.75 of static stretch) per 20 minutes of the experiment for every trial. Graphs are produced independently for treatment and control, a multiplot that shows treatment and control, and a single graph that shows treatment and control.    


```{r dotPlot}

#Experimental group subsetting and calculation of mean, standard deviation, and standard error. 

library(dplyr)
Exp_11 = Exp%>%
  group_by(Macro)%>%
  summarise(avg = mean(BL.tension, na.rm = TRUE))
 
Exp_12 = Exp%>%
  group_by(Macro)%>%
  summarise(SD = sd(BL.tension, na.rm=TRUE))

Exp_13 = as.data.frame(table(Exp$Macro))
Exp_11$SD = Exp_12$SD
Exp_11$n = as.numeric(Exp_13$Freq)
Exp_11$sqrt = sqrt(Exp_11$n)
Exp_11$SE = Exp_11$SD / Exp_11$sqrt
Exp_11$ymin = Exp_11$avg - Exp_11$SE
Exp_11$ymax = Exp_11$avg + Exp_11$SE
Exp_11$type = "Drug"


#plot of average for macro BL. Tension per macro scatter plot with errorbars Experiment 



library(ggplot2)

Exp8$num.type = 1
Exp8$min1 = mean(Exp8$ymin)
Exp8$max1 = mean(Exp8$ymax)


   ggplot(Exp8,aes(x=num.type, y=avg.all.macro, group = type, color = Macro)) + 
   geom_errorbar(aes(ymin=min1 , ymax=max1), width= 20) +
   geom_point()+
     geom_jitter()+
     ggtitle("Average SR for Treatment Group\n")+
  theme(plot.title = element_text(hjust=0.5))+
  labs(x="Drug\n", y = "Average SR\n")+
         theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
        
   
   

   
#plot of average for macro Bl.Tension per macro scatterplot with errorbars Control    

   Con8$num.type = 1.1

Con8$min1 = mean(Con8$ymin)
Con8$max1 = mean(Con8$ymax)


   ggplot(Con8,aes(x=num.type, y=avg.all.macro, group = type, color = Macro)) + 
   geom_errorbar(aes(ymin=min1 , ymax=max1), width= 20) +
   geom_point()+
     geom_jitter()+
     ggtitle("Average SR for Control Group\n")+
  theme(plot.title = element_text(hjust=0.5))+
  labs(x="Type\n", y = "Average SR\n")+
        theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
   

   

# plot comparing treatment and control scatter plots with errorbars. 

      #for multiplot
   b3=(ggplot(Con8,aes(x=num.type, y=avg.all.macro, group = type, color = Macro)) + 
   geom_errorbar(aes(ymin=min1 , ymax=max1), width= 20) +
   geom_point()+
     geom_jitter()+
     ggtitle("Average SR for Control Group\n")+
  theme(plot.title = element_text(hjust=0.5))+
  labs(x="Control\n", y = "Average SR\n"))+
        theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
   
   
   
      #for later multiplot
  a3= (ggplot(Exp8,aes(x=num.type, y=avg.all.macro, group = type, color = Macro)) + 
   geom_errorbar(aes(ymin=min1 , ymax=max1), width= 20) +
   geom_point()+
     geom_jitter()+
     ggtitle("Average SR versus Time for Treatment Group\n")+
  theme(plot.title = element_text(hjust=0.5))+
  labs(x="Drug\n", y = "Average SR\n"))+
       theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
   
   multiplot(a3,b3)
   
   #combining treatment and control using facet
   
Exp_Con11 = rbind(Exp8,Con8)

ggplot(Exp_Con11, aes(x=num.type, y=avg.all.macro, group = num.type, color = Macro))+
  #scale_colour_manual(values = c("steelblue", "darkblue"))+
  geom_point()+
  geom_errorbar(aes(ymin=min1, ymax= max1), size=0.5,   
    width=.25,position=position_dodge(.9))+
    theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
#theme(axis.text.x = element_text(angle = 0, hjust = 1))+
  geom_jitter()+
  facet_grid(type~.)+
  labs(x="Experiment type\n", y = "Average of all Macros\n")


#side by side experiment and control scatter plot with wrror bars

ggplot(Exp_Con11, aes(x=Exp_Con11$type, y=avg.all.macro, group = num.type, color =Macro))+
  geom_point()+
  geom_errorbar(aes(ymin=min1, ymax= max1), size=0.5,   
    width=.25,position=position_dodge(.9))+
  geom_jitter()+
  ggtitle("Average SR for treatment and control")+
  theme(plot.title = element_text(hjust=0.5))+
  labs(x="Experiment type\n", y = "Average of all Macros\n")
 
 
 
  

```

###Line plot with data visulization and standard deviation

Produces a line plot of peak tension as a percent variation from baseline tension over time of experiment. This graph also includes a picture of the afferent firing caused by the first static stretch. The caption of this graph lists the standard deviation values for each 20-minute period of the experiment. 

```{r lineDatavisualization}

library(dplyr)
library(png)
library(ggplot2)
library(grid)
#calculating standard deviation

 Exp8_sd = Exp%>%
  group_by(Macro)%>%
  summarise(sd = sd(average.of.all.interval.points, na.rm = TRUE))

Exp$sd = Exp8_sd$sd[match(Exp$Macro, Exp8_sd$Macro)]
my.labels <- paste(Exp$ramp.num, "\n (", Exp$sd, "%)")

#graph with image

img <- readPNG("..\\Tension_R\\img\\img.png")

g <- rasterGrob(img, interpolate=TRUE, height = 1, width = 1) #chnage height and width of the image 

  ggplot(Exp, aes(x= ramp.num, y= pvb.BL.tension, color = Trial)) +
    geom_point()+
  geom_line()+
    annotation_custom(g, xmin=-Inf, xmax=Inf, ymin= max(Exp$pvb.BL.tension) , ymax=Inf)+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+ 
  ggtitle("Baseline Tension")+
  theme(plot.title = element_text(hjust=0.5)) +
    scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline",  breaks = round(seq(min(Exp$pvb.BL.tension), max(Exp$pvb.BL.tension), by = 0.1),1))+
    expand_limits(y=1.7)
    
   
  
  #divides the standard deviation for each macro so it can be subsetted
  w1 = Exp8_sd$sd[1]
w2 = Exp8_sd$sd[2]
w3 = Exp8_sd$sd[3]
w4 = Exp8_sd$sd[4]
w5 = Exp8_sd$sd[5]
w6 = Exp8_sd$sd[6]
w7 =Exp8_sd$sd[7]

    
  # until I can find a better way to do this, highlight the line below, you will copy and paste these values under the caption on line 1086
    cat( w1, w2, w3, w4, w5, w6, w7, sep = "  ")
    
    
 #graph with image and standard deviation 
    
    img <- readPNG("..\\Tension_R\\img\\img.png")

g <- rasterGrob(img, interpolate=TRUE, height = 1, width = 1) #chnage height and width of the image 

  ggplot(Exp, aes(x= ramp.num, y= pvb.BL.tension, color = Trial)) +
    geom_point()+
  geom_line()+
    annotation_custom(g, xmin=-Inf, xmax=Inf, ymin= max(Exp$pvb.BL.tension) , ymax=Inf)+
  geom_smooth(method ="lm", se=FALSE, color = "black", aes (group = 1))+ 
  ggtitle("Baseline Tension")+
  theme(plot.title = element_text(hjust=0.5)) +
    scale_x_continuous("Time(Min.)", breaks = round(seq(min(Exp$ramp.num), max(Exp$ramp.num), by=2),1))+
   theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous("Percent varation from baseline",  breaks = round(seq(min(Exp$pvb.BL.tension), max(Exp$pvb.BL.tension), by = 0.1),1))+
    expand_limits(y=1.7)+
   labs(caption = "Standard Deviation: 6.663331  5.971332  6.484333  20.05963  6.174198  5.803291  9.505252") 
   

 
```

###Table Output

outputs a table for 10 sec. before static stretch (baseline tension), peak tension, average tension 3.25-3.27 of 4 sec. static stretch, and minimum tension in an excel (xlsx) format of transposed values with calculated average for each of the 20 minute periods. 

```{r tableOutput}

library(xlsx)
library(rJava)
library(dplyr)
library(reshape2)
library(reshape)


#dataframe manipulation for output format



#reshape data baseline

library(reshape)
Exp_19 = cast(Exp, Trial~ramp.num, value = "BL.tension" )
Exp_19$type = "BL.tension"
Exp_19$type.num = "4"


#reshape data peak tension
Exp_21 = cast(Exp, Trial~ramp.num, value = "peak.tension")
Exp_21$type = "peak.tension"
Exp_21$type.num = "3"

#reshape data SR tension
Exp_22 = cast(Exp, Trial~ramp.num, value = "average.of.all.interval.points")
Exp_22$type = "average.of.all.interval.points"
Exp_22$type.num = "2"

#reshape data min tension 

Exp_23 = cast(Exp, Trial~ramp.num, value = "Min.value")
Exp_23$type = "Min.value"
Exp_23$type.num = "1"

Exp_24 = bind_rows(list(Exp_19, Exp_21, Exp_22, Exp_23))

library(dplyr)

Exp_25 = Exp_24%>%
  arrange(Trial)

 

#write dataframe to excel sheet

write.xlsx(Exp_25, file = "C:\\Users\\Arthur\\255E\\Tension_R\\Exp_output\\Exp_out.xlsx", sheetName="Sheet1")




#data frame manipulation

#install.packages("htmlTable")

#library(htmlTable)


```



